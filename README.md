## Here are all the details to access MATLAB scripts and dataset related to this publication.
Please see the supplement of the publication for the implementation details.

Additional insights can be found in the final chapter of ["C. ELEGANS BEHAVIORS AND THEIR MECHANOSENSORY DRIVERS"](https://dataspace.princeton.edu/handle/88435/dsp01tt44pq78z)

The code is roughly divided into 3 parts: Real-time recording and stimulation in LabVIEW, post-processing in MATLAB, and generating figures in MATLAB

# Section 1: LabVIEW Real-time

requirements:
 - LabVIEW 2019 64-bit Windows
 - LabVIEW package manager
 - LabVIEW OpenG add-on
 - HDF5 v1.8.18+ (latest v1.8 but not v1.10)
 - h5labview

To run the real-time LabVIEW code, open the LabVIEW project at \LabviewVIs\ProjectAPI.lvproj and then select the appropriate experimental protocol vi. For example, the head/tail stimulation is done with RunHeadandTailRailswithDelays.vi.

Associated hardware in the correct configuration is required for the LabVIEW code to run properlly.

# Section 2: Post Processing 

requirements:
MATLAB 2016a

To conduct the post-processing on the raw datasets, run \ProcessDateDirectory.m and select the dataset when prompted.

# Section 3: Generating figures

a) Please read the `instruction_to_generate_figures.csv` to get detailed explanation of the which script is used to generate a specific figure and the location of the corresponding dataset folders. Please make sure to add the github repo to the path by selecting "Add to Path" and then selecting "Selected Folders and Subfolders". 

b) After all the dataset that has gone through post-processing, run `plot_figures_2_3_S1_S3_S4_S6.m` to generate figures 2, 3, S1, S3, S4, and S6 as shown in the publication by providing the corresponding input dataset fiolder.  

c) `Liu_etal_closed_loop_and_open_loop_analysis_1.m` is the primary code which is used to generate the information presented in figure 4, table 1 (Closed-loop optogenetic row), and supplementary table S1. The .mat files generated by this script is saved as .mat files and are used to generate figure 4 (see points e and f below)

d) `Liu_etal_counting_stim_on_turn_onset_in_open_loop_experiment_1.m` is the special case of the above code (`Liu_etal_closed_loop_and_open_loop_analysis_1.m`). It was used only to find the number of stim on turn onset events in open-loop assay for filling the information in table 1 (Open-loop optogenetic row for this work).

e) `plot_figure_4a.m` is the code to plot the bar plot for AML67 data i.e. figure 4a. It reads the .mat files for both open loop and closed loop datasets for AML67. 

f) `plot_figure_4b.m` is the code to plot the bar plot for AML470 data i.e. figure 4b. It reads the .mat files for both open loop and closed loop datasets for AML470. 

g) `plot_figure_S2.m` is the code to generate the supplementary figure S2 and the data corresponding to Stimulation during turning vs forward enteries in supplementary table S1 (columns cumulative recording length, animals per frame).

h) `plot_figure_S5.m` is the code to plot the habituation curve for both AML67 and AML470 as shown in supplementary figure S5.

# Section 4: Details of the dataset

a) List of all the folders which are used to generate figure 2, 3, S1, S2, S3, S4, and S6 are saved as .mat files in the folder `\liu-closed-loop-code\datasets_used_in_paper`. For. e.g. `\liu-closed-loop-code\datasets_used_in_paper\figure_2_dataset.mat` has the list of all the data folders which are used to generate figure 2.

b) The Dataset for figure 4a and figure 4b are saved as .mat files in `\liu-closed-loop-code\datasets_used_in_paper\figure_4a_dataset` and `\liu-closed-loop-code\datasets_used_in_paper\figure_4b_dataset` respectively. 

c) The dataset for AML67 and AML470 as shown in figure S5 are saved as .mat files in `\liu-closed-loop-code\datasets_used_in_paper\figure_S5_dataset`

d) The dataset used to present information in supplementary table S1 is saved as .mat files in `\liu-closed-loop-code\datasets_used_in_paper\supplementary_table_S1_dataset`. 